{% extends _layout %}
{% block css %}
    {{parent()}}
    <link rel="stylesheet" type="text/css" href="{{base_url()}}/bower_components/chosen/chosen.min.css">
{% endblock %}
{% block content %}

    <div class=row>
        <div class="col-md-6" role="main">
            {{ form_open(controller_name~'/consulta_picadas/', {'id' : 'consulta_picadas_form','method':'post'})}}
            <div class="bs-docs-section">
                <h1 id="overview" class="page-header">
                    Registros de Picadas Empleados
                </h1>
                <p>Visor general de los registros de picadas realizadas por los empleados.</p>
                <div class="form-group">
                    <label>Empleados: </label>
                    {{form_dropdown('id_empleado',empleados,'','class="chosen-select form-control" data-placeholder="Seleccione un empleado"')}}
                    <label for="from">Desde</label>
                    <input type="text" id="from" name="from">
                    <label for="to">hasta</label>
                    <input type="text" id="to" name="to">
                    <button id="btn_consulta_picadas" class="btn btn-success">Consultar</button>
                </div>
            </div>
            {{form_close()}}
        </div>
        <div class=col-md-6>
            {{ form_open_multipart(controller_name~'/load_data_reloj/' ~ data_info._id, {'id' : 'picada_form','method':'post'})}}
            <div id="content" class="bs-docs-header" tabindex="-1">
                <div class="container">
                    <h1 id="overview" class="page-header">Registro de Picadas</h1>
                    <p>Subir datos.</p>
                    <div id="required_fields_message"></div>
                    {{  form_label('Seleccionar archivo:', 'archivo', {'class' : 'ssmall_wide'}) }}
                    {{  form_upload({'type' : "file",'name' : "userfile",'id' : "userfile",'size' : "11"}) }}
                    <button id="btn_subir_archivo" class="btn btn-success" >Subir Informaci√≥n</button>
                </div>
            </div>
            {{form_close()}}
        </div>
        <div id="result"></div>
    </div>
{% endblock %}
{%block javascript%}
    {{parent()}}
    <script type="text/javascript" src="{{base_url()}}/bower_components/chosen/chosen.jquery.min.js"></script>
    <script type="text/javascript" src="{{base_url()}}/js/manage_table.js"></script>
    <script>
        var oTable;
        $(document).ready(function () {
            $('#consulta_picadas_form').validate({
                submitHandler: function (form) {
                    $(form).ajaxSubmit({
                        success: function (response) {
                            var horas_picar = "";
                            $.each(response.horario,function(key, value){
                                //alert(key + "-" + value);
                                if(key=="picadas")
                                    horas_picar = jQuery.parseJSON(value);
                                $("#result").append("<div>" + value + "</div>")
                            });
                            //alert ("apicar" + a_picar);
                            $.each(response.picadas,function(key, registro){ 
                                    tiempo = registro.fecha_picada.split(" ");
                                    $.each(horas_picar,function(i,pica){
                                        hora = parseInt(pica.split(":")[0]);
                                        minuto = parseInt(pica.split(":")[1]);
                                        if(pica.split(" ")[1] == "PM")
                                            hora += parseInt(12);
                                        rango_picada = hora * 60 + minuto;
                                        //alert(hora);
                                        //alert(pica);
                                        //if(tiempo[1] >= pica+10)
                                        $("#result").append("<div>" + tiempo[1] + "</div>")
                                        //$("#result").append("<div>" + tiempo + "</div>")
                                    });
                                    //alert(idx + "-" + picada);
                            });
                            //alert(response.horario);
                        },
                        dataType: 'json'
                    });
                },
                errorLabelContainer: "#required_fields_message",
                wrapper: "li",
                rules: {
                    to: {
                        required: true
                    },
                    from: {
                        required: true
                    }
                },
                messages: {
                    to: {
                        required: "Favor escojer una fecha hasta"
                    },
                    from: {
                        required: "Favor escojer una fecha desde"
                    }
                },
                debug: false
            });

            $(".chosen-select").chosen({no_results_text: 'No existe ese empleado!'});

            $.validator.addMethod('filesize', function (value, element, param) {
                return this.optional(element) || (element.files[0].size <= param);
            });

            $('#picada_form').validate({
                submitHandler: function (form) {
                    $(form).ajaxSubmit({
                        success: function (response) {
                            alert("alfin");
                        },
                        dataType: 'json'
                    });
                },
                errorLabelContainer: "#required_fields_message",
                wrapper: "li",
                rules: {
                    userfile: {
                        required: true,
                        extension: "log|txt",
                        filesize: 5242880
                    }
                },
                messages: {
                    userfile: {
                        required: "Favor escojer un archivo",
                        extension: "El archivo debe ser log o txt.",
                        filesize: "El archivo debe ser menor a 5MB"
                    }
                },
                debug: false
            });

            $(function () {
                $("#from").datepicker({
                    defaultDate: "+1w",
                    changeMonth: true,
                    numberOfMonths: 3,
                    onClose: function (selectedDate) {
                        $("#to").datepicker("option", "minDate", selectedDate);
                    }
                });
                $("#to").datepicker({
                    defaultDate: "+1w",
                    changeMonth: true,
                    numberOfMonths: 3,
                    onClose: function (selectedDate) {
                        $("#from").datepicker("option", "maxDate", selectedDate);
                    }
                });
            });


        });
        function post_picadas_form_submit(response) {
            if (!response.success) {
                set_feedback(response.message, "{{controller_name|upper}}", 'error');
            }
            else {
                if (jQuery.inArray(response.id, get_visible_checkbox_ids()) != -1) {
                    update_row(response.id, "{{ site_url(controller_name~"/get_row")}}");
                    set_feedback(response.message, "{{controller_name|upper}}", 'success');
                }
                else {
                    do_search(true, function () {
                        hightlight_row(response.id);
                        set_feedback(response.message, "{{controller_name|upper}}", 'success');
                    });
                }
            }
        }
    </script>
{% endblock %}