{% extends _layout %}
{% block css %}
    {{parent()}}
<link rel="stylesheet" type="text/css" href="{{base_url()}}/bower_components/chosen/chosen.min.css">
{% endblock %}
{% block content %}

<div class=row>
    <div class="col-md-6" role="main">
            {{ form_open(controller_name~'/consulta_picadas/', {'id' : 'consulta_picadas_form','method':'post'})}}
            <div class="bs-docs-section">
                <h1 id="overview" class="page-header">
                    Registros de Picadas Empleados
                </h1>
                <p>Visor general de los registros de picadas realizadas por los empleados.</p>
                <div class="form-group">
                    <label>Empleados: </label>
                    {{form_dropdown('id_empleado',empleados,'','class="chosen-select form-control" data-placeholder="Seleccione un empleado"')}}
                    <label for="from">Desde</label>
                    <input type="text" id="from" name="from">
                    <label for="to">hasta</label>
                    <input type="text" id="to" name="to">
                    <button id="btn_consulta_picadas" class="btn btn-success">Consultar</button>
                </div>
            </div>
            {{form_close()}}
        </div>
        <div class=col-md-6>
            {{ form_open_multipart(controller_name~'/load_data_reloj/' ~ data_info._id, {'id' : 'picada_form','method':'post'})}}
                <div class="bs-docs-header" tabindex="-1">
                    <h1 id="overview" class="page-header">Registro de Picadas</h1>
                    <p>Subir datos.</p>
                    <div id="required_fields_message"></div>
                    {{  form_label('Seleccionar archivo:', 'archivo', {'class' : 'ssmall_wide'}) }}
                    {{  form_upload({'type' : "file",'name' : "userfile",'id' : "userfile",'size' : "11"}) }}
                    <button id="btn_subir_archivo" class="btn btn-success" >Subir Informaci√≥n</button>
                </div>
            {{form_close()}}
            </div>
            <div id="result"></div>
        </div>
{% endblock %}
{%block javascript%}
    {{parent()}}
        <script type="text/javascript" src="{{base_url()}}/bower_components/chosen/chosen.jquery.min.js"></script>
        <script type="text/javascript" src="{{base_url()}}/js/manage_table.js"></script>
        <script>
            var oTable;
            $(document).ready(function() {
                $('#consulta_picadas_form').validate({
                    submitHandler: function(form) {
                        $(form).ajaxSubmit({
                            success: function(response) {
                                var horas_picar = "";
                                $.each(response.horario, function(key, value) {
                                    if (key == "picadas")
                                        horas_picar = jQuery.parseJSON(value);
                                    $("#result").append("<div>" + value + "</div>")
                                });
                                var rango = [];
                                var max_minutos_extras = 60 * 4;
                                $.each(horas_picar, function(i, pica) {
                                    hora_horario = parseInt(pica.split(":")[0]);
                                    minuto_horario = parseInt(pica.split(":")[1]);
                                    if (pica.split(" ")[1] == "PM")
                                        hora_horario += parseInt(12);
                                    minutos_horario = hora_horario * 60 + minuto_horario;
                                    rango.push(minutos_horario);
                                });
                                //Chequea si hubo ya una picada anterior.
                                var picada_anterior = 0;
                                var cambia_dia = "";
                                id_dia = 0;
                                var cll_picadas = [];
                                $.each(response.picadas, function(key, registro) {
                                    tiempo = registro.fecha_picada.split(" ");
                                    hora_picada = parseInt(tiempo[1].split(":")[0]);
                                    minuto_picada = parseInt(tiempo[1].split(":")[1]);
                                    minutos_picada = hora_picada * 60 + minuto_picada;
                                    console.log(cll_picadas.length + "-" + rango.length);

                                    cll_picadas.push(tiempo[1]);
                                    
                                    //console.log(cll_picadas.length == rango.length)
                                    //Primer caso, todo bien.
                                    if (cll_picadas.length == rango.length) {
                                        console.log("222")
                                        $.each(cll_picadas, function(idx, pica) {
                                            $("#result").append("<div>" + (idx+1) +  "-"+ pica + "</div>")
                                        });
                                        console.log("1")
                                        cll_picadas = [];
                                    } else if (cll_picadas.length > rango.length) {
                                        //Elimina picadas pegadas
                                        alert("fallo");
                                    } /*else if (id_dia != 0) {
                                        alert("fallo 2");
                                    } else
                                        alert("ee")*/
                                    if (tiempo[0] != cambia_dia) {
                                        cambia_dia = tiempo[0];
                                        $("#result").append("<div>Dia:" + tiempo[0] + "</div>");
                                        id_dia = 0;
                                    } else
                                        id_dia = id_dia + 1;

                                });
                                //if (minutos_picada - 60 > minutos_horario && minutos_picada + 60)
                                //$.each(rango, function(i, hora) {
                                /*if (tiempo[0] != cambia_dia || id_dia >= rango.length) {
                                 $("#result").append("<div>Dia:" + tiempo[0] + "</div>")
                                 id_dia = 0;
                                 $cambia_tiempo = tiempo[0];
                                 } else {
                                 id_dia = id_dia + 1;
                                 }
                                 if (id_dia < rango.length - 1) {
                                 indice = id_dia % 2 != 0 ? id_dia - 1 : id_dia;
                                 if (minutos_picada > rango[indice] - max_minutos_extras && minutos_picada < rango[indice + 1] + max_minutos_extras){
                                 $("#result").append("<div>" + tiempo[1] + "</div>")
                                 return false;
                                 }
                                 }*/
                                //});
                            },
                            dataType: 'json'
                        });
                    },
                    errorLabelContainer: "#required_fields_message",
                    wrapper: "li",
                    rules: {
                        to: {
                            required: true
                        },
                        from: {
                            required: true
                        }
                    },
                    messages: {
                        to: {
                            required: "Favor escojer una fecha hasta"
                        },
                        from: {
                            required: "Favor escojer una fecha desde"
                        }
                    },
                    debug: false
                });

                $(".chosen-select").chosen({no_results_text: 'No existe ese empleado!'});

                $.validator.addMethod('filesize', function(value, element, param) {
                    return this.optional(element) || (element.files[0].size <= param);
                });

                $('#picada_form').validate({
                    submitHandler: function(form) {
                        $(form).ajaxSubmit({
                            success: function(response) {
                                alert("alfin");
                            },
                            dataType: 'json'
                        });
                    },
                    errorLabelContainer: "#required_fields_message",
                    wrapper: "li",
                    rules: {
                        userfile: {
                            required: true,
                            extension: "log|txt",
                            filesize: 5242880
                        }
                    },
                    messages: {
                        userfile: {
                            required: "Favor escojer un archivo",
                            extension: "El archivo debe ser log o txt.",
                            filesize: "El archivo debe ser menor a 5MB"
                        }
                    },
                    debug: false
                });

                $(function() {
                    $("#from").datepicker({
                        defaultDate: "+1w",
                        changeMonth: true,
                        numberOfMonths: 3,
                        onClose: function(selectedDate) {
                            $("#to").datepicker("option", "minDate", selectedDate);
                        }
                    });
                    $("#to").datepicker({
                        defaultDate: "+1w",
                        changeMonth: true,
                        numberOfMonths: 3,
                        onClose: function(selectedDate) {
                            $("#from").datepicker("option", "maxDate", selectedDate);
                        }
                    });
                });


            });
            function post_picadas_form_submit(response) {
                if (!response.success) {
                    set_feedback(response.message, "{{controller_name|upper}}", 'error');
                }
                else {
                    if (jQuery.inArray(response.id, get_visible_checkbox_ids()) != -1) {
                        update_row(response.id, "{{ site_url(controller_name~"/get_row")}}");
                        set_feedback(response.message, "{{controller_name|upper}}", 'success');
                    }
                    else {
                        do_search(true, function() {
                            hightlight_row(response.id);
                            set_feedback(response.message, "{{controller_name|upper}}", 'success');
                        });
                    }
                }
            }
            </script>
{% endblock %}